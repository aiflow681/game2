<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>éœ“è™¹ä¿„ç½—æ–¯æ–¹å—ï¼šåŠ¨æ€çŸ©é˜µ</title>
<style>
/* å…¨å±€æ ·å¼é‡ç½® + åŸºç¡€æ ·å¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    background-color: #050608;
    color: white;
    overflow: hidden;
    user-select: none;
    -webkit-touch-callout: none;
    touch-action: none;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: sans-serif; /* ç³»ç»Ÿé»˜è®¤æ— è¡¬çº¿å­—ä½“ï¼Œæ›¿ä»£Googleå­—ä½“ */
}

/* æŒæœºå¤–å£³ï¼šåŸTailwindæ ·å¼è½¬åŸç”ŸCSS */
.handheld-shell {
    width: 100%;
    max-width: 380px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(145deg, #2a2e38 0%, #15181d 100%);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow:
        0 30px 60px rgba(0,0,0,0.8),
        inset 0 2px 2px rgba(255,255,255,0.1),
        inset 0 -2px 5px rgba(0,0,0,0.5);
    border-radius: 3.5rem;
    position: relative;
    padding: 2.5rem 1.5rem; /* åŸpy-10 px-6 */
    transition: padding 0.3s ease;
}

/* ç«–å±æ¨¡å¼é«˜åº¦ä¼˜åŒ–ï¼šåŸTailwindåª’ä½“æŸ¥è¯¢è½¬åŸç”Ÿ */
@media (orientation: portrait) {
    .handheld-shell {
        padding: 1.25rem 1.25rem; /* å‡å°‘å†…è¾¹è· */
    }
    .screen-bezel {
        margin-bottom: 0.5rem !important; /* åŸmb-6 â†’ mb-2 */
    }
    .bottom-decoration {
        margin-top: 0.5rem !important; /* åŸmt-8 â†’ mt-2 */
    }
    .control-area {
        gap: 0.5rem !important; /* å‡å°‘é—´éš™ */
    }
}

/* å±å¹•å¤–æ¡†ï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.screen-bezel {
    width: 100%;
    background: #0a0c10;
    padding: 8px;
    border-radius: 1.2rem;
    box-shadow:
        inset 0 4px 10px rgba(0,0,0,0.8),
        0 1px 1px rgba(255,255,255,0.05);
    border: 1px solid #333;
    margin-bottom: 1.5rem; /* åŸmb-6 */
}

/* å±å¹•é¡¶ç«¯çŠ¶æ€æ ï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 0.75rem 0.75rem 0.25rem; /* åŸpx-3 py-1 */
    background: #15181d;
    border-radius: 0.75rem 0.75rem 0 0; /* åŸrounded-t-lg */
    margin-bottom: 0.25rem; /* åŸmb-1 */
    border-bottom: 1px solid black;
}
.status-col {
    display: flex;
    flex-direction: column;
}
.status-col-right {
    align-items: flex-end;
}
.status-label {
    font-size: 7px;
    font-weight: 900;
    color: rgba(233, 43, 150, 0.8);
    letter-spacing: 0.1em; /* åŸtracking-widest */
    text-transform: uppercase;
}
.status-value-score {
    font-size: 1.125rem; /* åŸtext-lg */
    font-weight: 700; /* åŸfont-bold */
    color: rgba(255,255,255,0.9);
    line-height: 1; /* åŸleading-none */
    font-variant-numeric: tabular-nums; /* åŸtabular-nums */
}
.status-value-level {
    font-size: 1.125rem; /* åŸtext-lg */
    font-weight: 700; /* åŸfont-bold */
    font-style: italic;
    color: rgba(255,255,255,0.9);
    line-height: 1; /* åŸleading-none */
}

/* æ ¸å¿ƒæ˜¾ç¤ºåŒºï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.game-screen {
    position: relative;
    width: 100%;
    aspect-ratio: 1/2; /* åŸaspect-[1/2] */
    background: black;
    border-radius: 0.25rem; /* åŸrounded-md */
    overflow: hidden;
    background-image:
        linear-gradient(to right, rgba(233, 43, 150, 0.03) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(233, 43, 150, 0.03) 1px, transparent 1px);
    background-size: 30px 30px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.8); /* åŸshadow-inner */
}

/* æ‰«æçº¿åŠ¨ç”»ï¼ˆä¿ç•™åŸæœ‰ï¼‰ */
.scanline {
    width: 100%;
    height: 100%;
    background: linear-gradient(
        to bottom,
        rgba(233, 43, 150, 0) 0%,
        rgba(233, 43, 150, 0.05) 50%,
        rgba(233, 43, 150, 0) 100%
    );
    background-size: 100% 200%;
    position: absolute;
    top: 0; left: 0;
    animation: scan 6s linear infinite;
    pointer-events: none;
    z-index: 5;
}
@keyframes scan {
    from { background-position: 0 -100%; }
    to { background-position: 0 100%; }
}

/* ç”»å¸ƒæ ·å¼ */
#game-canvas {
    width: 100%;
    height: 100%;
    display: block;
}

/* é®ç½©å±‚ï¼šå¼•å¯¼/æš‚åœ/ç»“æŸï¼ˆåŸTailwindæ ·å¼è½¬åŸç”Ÿï¼‰ */
.screen-overlay {
    position: absolute;
    inset: 0; /* åŸinset-0 */
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem; /* åŸp-6 */
    text-align: center;
    z-index: 20;
    backdrop-filter: blur(0.125rem); /* åŸbackdrop-blur-sm */
}
.screen-overlay-gameover {
    background: rgba(0,0,0,0.95);
}
.screen-overlay-paused {
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(1px);
}
.overlay-icon {
    width: 4rem; /* åŸsize-16 */
    height: 4rem;
    border-radius: 50%;
    border: 1px solid rgba(233, 43, 150, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem; /* åŸmb-4 */
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; /* åŸanimate-pulse */
}
.overlay-icon-paused {
    width: 3.5rem; /* åŸsize-14 */
    height: 3.5rem;
    background: rgba(233, 43, 150, 0.2);
    border: 1px solid rgba(233, 43, 150, 0.5);
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.overlay-title {
    font-size: 0.75rem; /* åŸtext-xs */
    font-weight: 900;
    text-transform: uppercase;
    margin-bottom: 2rem; /* åŸmb-8 */
    letter-spacing: 0.4em; /* åŸtracking-[0.4em] */
    color: #e92b96; /* åŸtext-primary */
}
.overlay-title-gameover {
    font-size: 0.875rem; /* åŸtext-sm */
    color: #ef4444; /* åŸtext-red-500 */
    margin-bottom: 0.25rem; /* åŸmb-1 */
}
.overlay-desc {
    font-size: 9px;
    color: rgba(255,255,255,0.4);
    margin-bottom: 2rem; /* åŸmb-8 */
    text-transform: uppercase;
    letter-spacing: 0.1em; /* åŸtracking-widest */
}
.overlay-score {
    color: white;
}

/* æŒ‰é’®æ ·å¼ï¼ˆåŸTailwind+è‡ªå®šä¹‰æ ·å¼æ•´åˆï¼‰ */
.button-action {
    background: linear-gradient(180deg, #e92b96 0%, #9d1b64 100%);
    border: 1px solid #f06292;
    border-bottom: 5px solid #62113e;
    box-shadow: 0 4px 15px rgba(233, 43, 150, 0.3);
    color: white;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.75rem 2rem; /* åŸpx-8 py-3 */
    border-radius: 9999px; /* åŸrounded-full */
    font-size: 10px;
    transition: all 0.1s ease;
}
.button-action:active {
    transform: scale(0.95); /* åŸactive:scale-95 */
}
.button-action-drop {
    width: 100%;
    padding: 1.25rem 0; /* åŸpy-5 */
    border-radius: 1rem; /* åŸrounded-2xl */
}
.button-action:active {
    transform: translateY(3px);
    border-bottom-width: 1px;
    box-shadow: 0 1px 5px rgba(233, 43, 150, 0.5);
}

/* è£…é¥°ï¼šå››è§’èºä¸ï¼ˆä¿ç•™åŸæœ‰ï¼‰ */
.screw {
    width: 6px;
    height: 6px;
    background: #333;
    border-radius: 50%;
    box-shadow: inset 0 1px 1px #000, 1px 1px 0 rgba(255,255,255,0.05);
    position: absolute;
}
.screw-top-left { top: 1.5rem; left: 1.5rem; } /* åŸtop-6 left-6 */
.screw-top-right { top: 1.5rem; right: 1.5rem; }
.screw-bottom-left { bottom: 1.5rem; left: 1.5rem; }
.screw-bottom-right { bottom: 1.5rem; right: 1.5rem; }

/* è£…é¥°ï¼šå–‡å­å­”ï¼ˆåŸTailwindæ ·å¼è½¬åŸç”Ÿï¼‰ */
.speaker-holes {
    position: absolute;
    left: 1.5rem; /* åŸleft-6 */
    top: 33.333%; /* åŸtop-1/3 */
    display: flex;
    flex-direction: column;
    gap: 0.375rem; /* åŸgap-1.5 */
    opacity: 0.3; /* åŸopacity-30 */
}
.speaker-hole {
    width: 0.375rem; /* åŸw-1.5 */
    height: 0.375rem; /* åŸh-1.5 */
    background: black;
    border-radius: 50%;
    box-shadow: inset 0 0 2px rgba(0,0,0,0.8); /* åŸshadow-inner */
}

/* æŒæœºæŒ‰é’®åŒºåŸŸï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.control-area {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem; /* åŸgap-4 */
    padding: 0 0.5rem; /* åŸpx-2 */
}

/* æ–¹å‘é”®ï¼ˆD-Padï¼‰ï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.dpad {
    position: relative;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.125rem; /* åŸgap-0.5 */
    transform: scale(1.1); /* åŸscale-110 */
}
.dpad-center {
    width: 12px;
    height: 12px;
    background: #111;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
    z-index: 10;
    pointer-events: none;
}
.physical-button {
    background: linear-gradient(180deg, #323842 0%, #1a1d24 100%);
    border: 1px solid #444;
    border-bottom: 4px solid #000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.4);
    transition: all 0.05s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #aaa;
    width: 2.75rem; /* åŸsize-11 */
    height: 2.75rem;
    font-size: 1.25rem; /* å›¾æ ‡å¤§å° */
}
.physical-button-sm {
    width: 2.5rem; /* åŸsize-10 */
    height: 2.5rem;
    font-size: 0.875rem; /* åŸtext-sm */
    border-radius: 50%; /* åŸrounded-full */
}
.physical-button-up { border-radius: 0.5rem 0.5rem 0 0; } /* åŸrounded-t-lg */
.physical-button-left { border-radius: 0.5rem 0 0 0.5rem; } /* åŸrounded-l-lg */
.physical-button-right { border-radius: 0 0.5rem 0.5rem 0; } /* åŸrounded-r-lg */
.physical-button:active {
    transform: translateY(2px);
    border-bottom-width: 1px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.6);
    filter: brightness(1.2);
    color: #fff;
}

/* æ“ä½œé”®åŒºåŸŸï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem; /* åŸgap-4 */
    flex: 1;
    align-items: flex-end;
}
.action-buttons-top {
    display: flex;
    gap: 0.75rem; /* åŸgap-3 */
}
.action-button-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem; /* åŸgap-1 */
}
.action-button-label {
    font-size: 6px;
    font-weight: 700;
    color: rgba(255,255,255,0.2);
    text-transform: uppercase;
    letter-spacing: 0.05em; /* åŸtracking-tighter */
}
.action-button-label-drop {
    font-size: 6px;
    font-weight: 700;
    color: rgba(255,255,255,0.3);
    text-transform: uppercase;
    text-align: center;
    letter-spacing: 0.1em; /* åŸtracking-widest */
    margin-bottom: 0.25rem;
}

/* åº•éƒ¨è£…é¥°ï¼šåŸTailwindæ ·å¼è½¬åŸç”Ÿ */
.bottom-decoration {
    margin-top: 2rem; /* åŸmt-8 */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem; /* åŸgap-1 */
    opacity: 0.2; /* åŸopacity-20 */
}
.decoration-line {
    width: 5rem; /* åŸw-20 */
    height: 0.25rem; /* åŸh-1 */
    background: black;
    border-radius: 9999px; /* åŸrounded-full */
}
.decoration-text {
    font-size: 7px;
    font-weight: 700;
    color: white;
    letter-spacing: 0.6em; /* åŸtracking-[0.6em] */
    text-transform: uppercase;
}

/* å“åº”å¼ç¼©æ”¾ï¼šåŸTailwindåª’ä½“æŸ¥è¯¢è½¬åŸç”Ÿ */
@media (max-height: 750px) {
    .handheld-shell { transform: scale(0.9); }
}

/* éšè—ç±»ï¼ˆç”¨äºé®ç½©å±‚åˆ‡æ¢ï¼‰ */
.hidden {
    display: none !important;
}
</style>
</head>
<body>
<!-- æŒæœºä¸»ä½“ -->
<div class="handheld-shell">
    <!-- è£…é¥°ï¼šå››è§’çš„èºä¸ -->
    <div class="screw screw-top-left"></div>
    <div class="screw screw-top-right"></div>
    <div class="screw screw-bottom-left"></div>
    <div class="screw screw-bottom-right"></div>

    <!-- è£…é¥°ï¼šå–‡å­å­” -->
    <div class="speaker-holes">
        <div class="speaker-hole"></div>
        <div class="speaker-hole"></div>
        <div class="speaker-hole"></div>
    </div>

    <!-- å±å¹•å¤–æ¡† -->
    <div class="screen-bezel">
        <!-- å±å¹•é¡¶ç«¯çŠ¶æ€ -->
        <div class="status-bar">
            <div class="status-col">
                <span class="status-label">æ•°æ®æŠ¥æ–‡</span>
                <span class="status-value-score" id="stat-score">000000</span>
            </div>
            <div class="status-col status-col-right">
                <span class="status-label">å½“å‰ç­‰çº§</span>
                <span class="status-value-level" id="stat-level">01</span>
            </div>
        </div>

        <!-- æ ¸å¿ƒæ˜¾ç¤ºåŒº -->
        <div class="game-screen">
            <div class="scanline"></div>
            <canvas id="game-canvas"></canvas>

            <!-- é®ç½©å±‚ï¼šå¼•å¯¼ -->
            <div id="screen-idle" class="screen-overlay">
                <div class="overlay-icon">
                    <span style="color: #e92b96; font-size: 2rem;">ğŸ“±</span> <!-- æ›¿ä»£åŸsensorså›¾æ ‡ -->
                </div>
                <h3 class="overlay-title">ç³»ç»Ÿå°±ç»ª</h3>
                <button id="btn-engage" class="button-action">åŒæ­¥çŸ©é˜µ</button>
            </div>

            <!-- é®ç½©å±‚ï¼šæ¸¸æˆç»“æŸ -->
            <div id="screen-gameover" class="screen-overlay screen-overlay-gameover hidden">
                <span style="color: #ef4444; font-size: 3rem; margin-bottom: 1rem;">âŒ</span> <!-- æ›¿ä»£åŸcancelå›¾æ ‡ -->
                <h3 class="overlay-title overlay-title-gameover">è¿æ¥ä¸­æ–­</h3>
                <p class="overlay-desc">æœ€ç»ˆç§¯åˆ†: <span class="overlay-score" id="final-score">0</span></p>
                <button id="btn-restart" class="button-action">é‡å¯ç³»ç»Ÿ</button>
            </div>

            <!-- é®ç½©å±‚ï¼šæš‚åœ -->
            <div id="screen-paused" class="screen-overlay screen-overlay-paused hidden">
                <div class="overlay-icon overlay-icon-paused">
                    <span style="color: #e92b96; font-size: 2rem;" id="pause-icon">â¸ï¸</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒæœºæŒ‰é’®åŒºåŸŸ -->
    <div class="control-area">
        <!-- æ–¹å‘é”® (D-Pad) -->
        <div class="dpad">
            <div class="dpad-center"></div>
            <div style="grid-column: 2;"> <!-- åŸcol-start-2 -->
                <button id="ctrl-up" class="physical-button physical-button-up">â†‘</button>
            </div>
            <div style="grid-column: 1; grid-row: 2;"> <!-- åŸcol-start-1 row-start-2 -->
                <button id="ctrl-left" class="physical-button physical-button-left">â†</button>
            </div>
            <div style="grid-column: 2; grid-row: 2;"> <!-- åŸcol-start-2 row-start-2 -->
                <button id="ctrl-down" class="physical-button">â†“</button>
            </div>
            <div style="grid-column: 3; grid-row: 2;"> <!-- åŸcol-start-3 row-start-2 -->
                <button id="ctrl-right" class="physical-button physical-button-right">â†’</button>
            </div>
        </div>

        <!-- æ“ä½œé”® (Action) -->
        <div class="action-buttons">
            <div class="action-buttons-top">
                <div class="action-button-col">
                    <span class="action-button-label">æš‚åœ</span>
                    <button id="btn-play-toggle" class="physical-button physical-button-sm">
                        <span id="play-icon">â–¶ï¸</span>
                    </button>
                </div>
                <div class="action-button-col">
                    <span class="action-button-label">é‡ç½®</span>
                    <button id="btn-refresh" class="physical-button physical-button-sm">ğŸ”„</button>
                </div>
            </div>

            <div style="width: 100%;">
                <span class="action-button-label-drop">å¼ºåŠ›ä¸‹å </span>
                <button id="ctrl-drop" class="button-action button-action-drop">
                    æ‰§è¡Œç¨‹åº
                </button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å‹å·è£…é¥° -->
    <div class="bottom-decoration">
        <div class="decoration-line"></div>
        <div class="decoration-text">éœ“è™¹è¡—æœº // ä¼å‹</div>
    </div>
</div>

<script>
// å¸¸é‡å®šä¹‰ï¼ˆè¯­ä¹‰åŒ–å‘½åï¼‰
const COLUMN_COUNT = 10;
const ROW_COUNT = 20;
const SHAPES = {
    'I': [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
    'J': [[1,0,0],[1,1,1],[0,0,0]],
    'L': [[0,0,1],[1,1,1],[0,0,0]],
    'O': [[1,1],[1,1]],
    'S': [[0,1,1],[1,1,0],[0,0,0]],
    'T': [[0,1,0],[1,1,1],[0,0,0]],
    'Z': [[1,1,0],[0,1,1],[0,0,0]]
};
const COLORS = {
    'I': '#00f3ff', 'J': '#3b82f6', 'L': '#f59e0b', 'O': '#fbbf24',
    'S': '#10b981', 'T': '#e92b96', 'Z': '#ef4444'
};

// æ¸¸æˆçŠ¶æ€
let gameState = {
    board: Array.from({ length: ROW_COUNT }, () => Array(COLUMN_COUNT).fill(null)),
    activePiece: null,
    nextPiece: null,
    score: 0,
    level: 1,
    lines: 0,
    status: 'IDLE'
};

let lastFrameTime = 0;
let dropCounter = 0;
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');

// å“åº”å¼ç”»å¸ƒè°ƒæ•´
function resizeCanvas() {
    canvas.width = canvas.clientWidth * devicePixelRatio;
    canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// éšæœºç”Ÿæˆæ–°æ–¹å—
function getRandomPiece() {
    const shapeKeys = Object.keys(SHAPES);
    const pieceType = shapeKeys[Math.floor(Math.random() * shapeKeys.length)];
    return {
        type: pieceType,
        shape: SHAPES[pieceType],
        color: COLORS[pieceType]
    };
}

// åœ¨é¡¶éƒ¨ç”Ÿæˆæ–°æ–¹å—
function spawnPiece() {
    gameState.activePiece = {
        piece: gameState.nextPiece || getRandomPiece(),
        position: {
            x: Math.floor(COLUMN_COUNT / 2) - 1,
            y: 0
        }
    };
    gameState.nextPiece = getRandomPiece();
    // ç¢°æ’æ£€æµ‹ï¼Œæ¸¸æˆç»“æŸåˆ¤æ–­
    if (checkCollision(gameState.activePiece.piece, gameState.activePiece.position)) {
        gameState.status = 'GAMEOVER';
        updateUI();
    }
}

// ç¢°æ’æ£€æµ‹
function checkCollision(piece, position) {
    for (let yIndex = 0; yIndex < piece.shape.length; yIndex++) {
        for (let xIndex = 0; xIndex < piece.shape[yIndex].length; xIndex++) {
            if (piece.shape[yIndex][xIndex]) {
                const newX = position.x + xIndex;
                const newY = position.y + yIndex;
                // è¾¹ç•Œæ£€æµ‹ + ç›˜é¢ç¢°æ’æ£€æµ‹ï¼ˆæ³¨æ„æ‹¬å·ä¼˜å…ˆçº§ï¼‰
                if (newX < 0 || newX >= COLUMN_COUNT || newY >= ROW_COUNT || (newY >= 0 && gameState.board[newY][newX])) {
                    return true;
                }
            }
        }
    }
    return false;
}

// æ–¹å—æ—‹è½¬ï¼ˆçŸ©é˜µé¡ºæ—¶é’ˆè½¬ç½®ï¼‰
function rotatePiece(piece) {
    const newShape = piece.shape[0].map((_, index) => piece.shape.map(row => row[index]).reverse());
    return { ...piece, shape: newShape };
}

// ç§»åŠ¨æ–¹å—é€»è¾‘
function movePiece(deltaX, deltaY) {
    if (gameState.status !== 'PLAYING') return;

    const newPosition = {
        x: gameState.activePiece.position.x + deltaX,
        y: gameState.activePiece.position.y + deltaY
    };

    if (!checkCollision(gameState.activePiece.piece, newPosition)) {
        gameState.activePiece.position = newPosition;
        return true;
    } else if (deltaY > 0) {
        // å‘ä¸‹ç§»åŠ¨ç¢°æ’ï¼Œé”å®šæ–¹å—
        lockPiece();
    }
    return false;
}

// é”å®šæ–¹å—åˆ°ç›˜é¢
function lockPiece() {
    const { piece, position } = gameState.activePiece;
    piece.shape.forEach((row, yIndex) => {
        row.forEach((cellValue, xIndex) => {
            if (cellValue) {
                const boardY = position.y + yIndex;
                const boardX = position.x + xIndex;
                if (boardY >= 0 && boardY < ROW_COUNT) {
                    gameState.board[boardY][boardX] = piece.color;
                }
            }
        });
    });
    clearLines();
    spawnPiece();
    updateUI();
}

// æ¶ˆè¡Œé€»è¾‘
function clearLines() {
    let clearedLines = 0;
    // è¿‡æ»¤æ‰æ»¡è¡Œï¼Œç»Ÿè®¡æ¶ˆé™¤è¡Œæ•°
    gameState.board = gameState.board.filter(row => {
        const isFullRow = row.every(cell => cell !== null);
        if (isFullRow) clearedLines++;
        return !isFullRow;
    });
    // è¡¥è¶³é¡¶éƒ¨ç©ºè¡Œ
    while (gameState.board.length < ROW_COUNT) {
        gameState.board.unshift(Array(COLUMN_COUNT).fill(null));
    }
    // è®¡åˆ†é€»è¾‘
    if (clearedLines > 0) {
        const scorePoints = [0, 100, 300, 500, 800];
        gameState.lines += clearedLines;
        gameState.score += scorePoints[clearedLines] * gameState.level;
        gameState.level = Math.floor(gameState.lines / 10) + 1;
    }
}

// æ¸²æŸ“ä¸»å¾ªç¯
function drawGameFrame(time = 0) {
    const deltaTime = time - lastFrameTime;
    lastFrameTime = time;

    // è‡ªåŠ¨ä¸‹è½é€»è¾‘
    if (gameState.status === 'PLAYING') {
        dropCounter += deltaTime;
        const fallSpeed = 1000 / (gameState.level * 0.8 + 0.5);
        if (dropCounter > fallSpeed) {
            movePiece(0, 1);
            dropCounter = 0;
        }
    }

    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // è®¡ç®—æ¯ä¸ªæ–¹å—çš„å®½é«˜
    const blockWidth = (canvas.width / devicePixelRatio) / COLUMN_COUNT;
    const blockHeight = (canvas.height / devicePixelRatio) / ROW_COUNT;

    // 1. ç»˜åˆ¶å·²å›ºå®šçš„æ–¹å—
    gameState.board.forEach((row, yIndex) => {
        row.forEach((cellColor, xIndex) => {
            if (cellColor) {
                drawBlock(ctx, xIndex, yIndex, cellColor, blockWidth, blockHeight);
            }
        });
    });

    // 2. ç»˜åˆ¶æ´»åŠ¨æ–¹å—ï¼ˆå«æŠ•å½±ï¼‰
    if (gameState.activePiece && gameState.status !== 'IDLE') {
        const { piece, position } = gameState.activePiece;

        // ç»˜åˆ¶æŠ•å½±ï¼ˆGhostï¼‰
        let ghostY = position.y;
        while (!checkCollision(piece, { x: position.x, y: ghostY + 1 })) {
            ghostY++;
        }
        piece.shape.forEach((row, yIndex) => {
            row.forEach((cellValue, xIndex) => {
                if (cellValue) {
                    drawBlock(ctx, position.x + xIndex, ghostY + yIndex, piece.color, blockWidth, blockHeight, true);
                }
            });
        });

        // ç»˜åˆ¶æ–¹å—æœ¬ä½“
        piece.shape.forEach((row, yIndex) => {
            row.forEach((cellValue, xIndex) => {
                if (cellValue) {
                    drawBlock(ctx, position.x + xIndex, position.y + yIndex, piece.color, blockWidth, blockHeight);
                }
            });
        });
    }

    // å¾ªç¯æ¸²æŸ“
    requestAnimationFrame(drawGameFrame);
}

// ç»˜åˆ¶å•ä¸ªæ–¹å—å•å…ƒ
function drawBlock(ctx, x, y, color, width, height, isGhost = false) {
    ctx.save();
    ctx.translate(x * width, y * height);

    if (isGhost) {
        // æŠ•å½±æ ·å¼
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = 0.2;
        ctx.strokeRect(2, 2, width - 4, height - 4);
    } else {
        // å®ä½“æ–¹å—ï¼ˆéœ“è™¹3Dæ•ˆæœï¼‰
        ctx.fillStyle = color;
        ctx.shadowBlur = 12;
        ctx.shadowColor = color;
        ctx.beginPath();
        ctx.roundRect(2, 2, width - 4, height - 4, 3);
        ctx.fill();

        // é¡¶éƒ¨é«˜å…‰
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.fillRect(4, 4, width - 8, 2);

        // åº•éƒ¨æš—å½±
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fillRect(4, height - 6, width - 8, 2);
    }

    ctx.restore();
}

// åŒæ­¥UIæ˜¾ç¤º
function updateUI() {
    document.getElementById('stat-score').innerText = gameState.score.toString().padStart(6, '0');
    document.getElementById('stat-level').innerText = gameState.level.toString().padStart(2, '0');
    document.getElementById('screen-idle').classList.toggle('hidden', gameState.status !== 'IDLE');
    document.getElementById('screen-gameover').classList.toggle('hidden', gameState.status !== 'GAMEOVER');
    document.getElementById('screen-paused').classList.toggle('hidden', gameState.status !== 'PAUSED');
    document.getElementById('final-score').innerText = gameState.score;
    document.getElementById('play-icon').innerText = gameState.status === 'PLAYING' ? 'â¸ï¸' : 'â–¶ï¸';
}

// å¯åŠ¨æ¸¸æˆ
function startGame() {
    gameState.board = Array.from({ length: ROW_COUNT }, () => Array(COLUMN_COUNT).fill(null));
    gameState.score = 0;
    gameState.level = 1;
    gameState.lines = 0;
    gameState.status = 'PLAYING';
    spawnPiece();
    updateUI();
}

// æš‚åœ/ç»§ç»­åˆ‡æ¢
function togglePlayPause() {
    if (gameState.status === 'PLAYING') {
        gameState.status = 'PAUSED';
    } else if (gameState.status === 'PAUSED') {
        gameState.status = 'PLAYING';
    } else if (gameState.status === 'IDLE' || gameState.status === 'GAMEOVER') {
        startGame();
    }
    updateUI();
}

// äº¤äº’ç»‘å®šè¾…åŠ©å‡½æ•°
function bindButtonEvent(buttonId, callback) {
    const buttonElement = document.getElementById(buttonId);
    if (!buttonElement) return;
    
    buttonElement.ontouchstart = (event) => {
        event.preventDefault();
        callback();
    };
    buttonElement.onmousedown = () => {
        callback();
    };
}

// ç»‘å®šæŒ‰é’®äº‹ä»¶
bindButtonEvent('btn-engage', startGame);
bindButtonEvent('btn-restart', startGame);
bindButtonEvent('btn-refresh', startGame);
bindButtonEvent('btn-play-toggle', togglePlayPause);
bindButtonEvent('ctrl-left', () => movePiece(-1, 0));
bindButtonEvent('ctrl-right', () => movePiece(1, 0));
bindButtonEvent('ctrl-down', () => movePiece(0, 1));
bindButtonEvent('ctrl-up', () => {
    if (!gameState.activePiece) return;
    const rotatedPiece = rotatePiece(gameState.activePiece.piece);
    if (!checkCollision(rotatedPiece, gameState.activePiece.position)) {
        gameState.activePiece.piece = rotatedPiece;
    }
});
bindButtonEvent('ctrl-drop', () => {
    if (gameState.status !== 'PLAYING') return;
    // å¼ºåŠ›ä¸‹å ï¼šå¾ªç¯ç§»åŠ¨ç›´åˆ°ç¢°æ’
    while (movePiece(0, 1));
});

// é”®ç›˜äº‹ä»¶æ”¯æŒ
window.onkeydown = (event) => {
    switch(event.key) {
        case 'ArrowLeft': movePiece(-1, 0); break;
        case 'ArrowRight': movePiece(1, 0); break;
        case 'ArrowDown': movePiece(0, 1); break;
        case 'ArrowUp': 
        case 'w': {
            if (!gameState.activePiece) return;
            const rotatedPiece = rotatePiece(gameState.activePiece.piece);
            if (!checkCollision(rotatedPiece, gameState.activePiece.position)) {
                gameState.activePiece.piece = rotatedPiece;
            }
            break;
        }
        case ' ': // ç©ºæ ¼å¼ºåŠ›ä¸‹å 
            if (gameState.status === 'PLAYING') {
                while (movePiece(0, 1));
            }
            break;
        case 'p':
        case 'Escape': // Pé”®/Escæš‚åœ
            togglePlayPause();
            break;
    }
};

// å¯åŠ¨æ¸²æŸ“å¾ªç¯
requestAnimationFrame(drawGameFrame);
</script>
</body>
</html>